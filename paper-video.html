<!--
@author Arshak Khachatrian (<a href="mailto:akhxtern@gmail.com">akhxtern@gmail.com</a>)
@website http://spacee.xyz
@updateDate May 14, 2016

**********
*
*   *** PAPER VIDEO ***
*   
*   This floating action button is using the Material Design concept of expandable
*   Paper Fab Button and using the Polymer components to make the concept happen.
*   
*  
*
********** -->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/av-icons.html">
<dom-module id="paper-video">
	<style is="custom-style">
		:host .container {
			position: relative;
			display: inline-block;
		}
		:host #videoControls {
			position: absolute;
			bottom: 0;
			left: 0;
			right: 0;
			display: flex;
			background-color: white;
			padding: 15px;
			align-items: center;
		}
		:host paper-ripple {
			color: white;
			opacity: 0.4;
		}
		:host #durationSlider {
			flex: 1;
		}
		:host #volumeSlider {
			max-width: 120px;
		}
		:host .video-time {
		    font-family: 'Roboto';
    		font-size: 12px;
		}
		:host #container:-webkit-full-screen, :host #container:-webkit-full-screen video {
		  width: 100vw;
		  height: 100vh;
		}
	</style>
	<template>
		<div id="container" class="container">
			<paper-ripple></paper-ripple>
			<div class="video">
				<video on-tap="toggle" width$="{{width}}" muted$="{{muted}}" poster$="{{poster}}" preload$="{{preload}}" height$="{{height}}" id="paperVideo" src$="{{src}}" autoplay$="{{autoplay}}" loop$="{{loop}}"></video>
			</div>
			<paper-material elevation="1" hidden$="{{!controls}}" id="videoControls">
				<paper-icon-button id="playPauseIcon" on-tap="toggle" icon="av:play-arrow"></paper-icon-button>
				<span class="video-time">{{currentTick}}/{{durationTick}}</span>
				<paper-slider id="durationSlider" value="{{videoTimeline}}"></paper-slider>
				<paper-icon-button id="toggleMute" icon="av:volume-up"></paper-icon-button>
				<paper-slider id="volumeSlider" value="{{videoVolume}}"></paper-slider>
				<paper-icon-button id="fullScreen" icon="icons:fullscreen"></paper-icon-button>
			</div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'paper-video',
			properties: {
				controls: {
					type: Boolean,
					value: false
				},
				autoplay: {
					type: Boolean,
					value: false
				},
				loop: {
					type: Boolean,
					value: false
				},
				preload: {
					type: Boolean,
					value: false
				},
				poster: {
					type: Boolean,
					value: false
				},
				muted: {
					type: Boolean,
					value: false
				},
				videoVolume: {
					value: 100
				}
			},
			attached: function(){

				var that = this,
					video;

				that.$.paperVideo.addEventListener('canplay', function(){
					video = that.$.paperVideo;

					that.currentTick = that.readableDuration(video.currentTime);
					that.durationTick = that.readableDuration(video.duration);
				})

				that.$.paperVideo.addEventListener('timeupdate', function(){

					video = that.$.paperVideo;
					that.currentTick = that.readableDuration(video.currentTime);

					// Setting the video parameters to the component
					that.duration = video.duration;
					that.videoTimeline = ( video.currentTime / video.duration ) * 100;

				});

				function setTimelineFrame(e){
					video = that.$.paperVideo;
					video.currentTime = Math.floor(video.duration * e.target.getAttribute('value') / 100);
				}

				that.$.durationSlider.addEventListener('change', setTimelineFrame);
				that.$.volumeSlider.addEventListener('change', function(e){
					video.volume = that.videoVolume / 100;

					if(video.volume) {
						that.$.toggleMute.setAttribute('icon', 'av:volume-up');
					} else {
						that.$.toggleMute.setAttribute('icon', 'av:volume-off');
					}
				});

				var volume;
				that.$.toggleMute.addEventListener('click', function(e){

					if(that.videoVolume) {
						volume = that.videoVolume;
						video.volume = that.videoVolume = 0;
					} else {
						volume && (video.volume = volume / 100);
						volume && (that.videoVolume = volume)
					}

					that.$.volumeSlider.fire('change');
				});
				that.$.fullScreen.addEventListener('click', function(){
					that.toggleFullScreen();
				});
			},
			readableDuration: function(seconds) {
				sec = Math.floor( seconds );
				min = Math.floor( sec / 60 );
				min = min >= 10 ? min : '0' + min;
				sec = Math.floor( sec % 60 );
				sec = sec >= 10 ? sec : '0' + sec;

				return min + ':' + sec;
		    },
			play: function(){
				this.$.playPauseIcon.setAttribute('icon', 'av:pause');
				return this.$.paperVideo.play();
			},
			pause: function(){
				this.$.playPauseIcon.setAttribute('icon', 'av:play-arrow');
				return this.$.paperVideo.pause();
			},
			toggle: function(){
				var that = this,
				video = that.$.paperVideo;

				if(video.paused || video.ended) {
					that.play();
				} else {
					that.pause();
				}
			},
			toggleFullScreen: function() {
				var elem = this.$.container;

				if (!elem.fullscreenElement && !elem.mozFullScreenElement && !elem.webkitFullscreenElement && !elem.msFullscreenElement ) {
					if (elem.requestFullscreen) {
					  elem.requestFullscreen();
					} else if (elem.msRequestFullscreen) {
					  elem.msRequestFullscreen();
					} else if (elem.mozRequestFullScreen) {
					  elem.mozRequestFullScreen();
					} else if (elem.webkitRequestFullscreen) {
					  elem.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
					}
				} else {
					if (elem.exitFullscreen) {
					  elem.exitFullscreen();
					} else if (elem.msExitFullscreen) {
					  elem.msExitFullscreen();
					} else if (elem.mozCancelFullScreen) {
					  elem.mozCancelFullScreen();
					} else if (elem.webkitExitFullscreen) {
					  elem.webkitExitFullscreen();
					}
				}
			}
		})
	</script>
</dom-module>